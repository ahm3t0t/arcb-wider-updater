name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ahm3t0t

jobs:
  # ==================== Lint ====================
  lint:
    name: ShellCheck Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: actionlint (YAML lint)
        uses: reviewdog/action-actionlint@v1
        continue-on-error: true
        with:
          reporter: github-pr-check
          fail_level: none

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt

      - name: Bash syntax check
        run: |
          bash -n guncel
          bash -n install.sh
          bash -n release.sh

      - name: ShellCheck (warnings)
        run: |
          shellcheck -S warning guncel install.sh release.sh

      - name: shfmt check (Google style)
        run: |
          # Check only, don't modify (-d = diff, -i 2 = 2 space indent)
          shfmt -d -i 2 -ci -sr guncel install.sh release.sh || echo "::warning::Code style differs from Google Shell Style Guide"

  # ==================== Multi-Distro Matrix Test ====================
  multi-distro:
    name: ${{ matrix.distro }} (${{ matrix.pkg_manager }})
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15
    environment: production

    permissions:
      contents: read
      packages: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu
            pkg_manager: APT
            image: ubuntu:24.04
            ghcr_image: ghcr.io/ahm3t0t/bigfive-base-ubuntu:latest
            setup: apt-get update && apt-get install -y curl wget sudo gawk ca-certificates
          - distro: fedora
            pkg_manager: DNF
            image: fedora:40
            ghcr_image: ghcr.io/ahm3t0t/bigfive-base-fedora:latest
            setup: dnf install -y curl wget sudo gawk ca-certificates hostname
          - distro: arch
            pkg_manager: Pacman
            image: archlinux:latest
            ghcr_image: ghcr.io/ahm3t0t/bigfive-base-arch:latest
            setup: pacman -Sy --noconfirm curl wget sudo gawk ca-certificates
          - distro: opensuse
            pkg_manager: Zypper
            image: opensuse/leap:15.6
            ghcr_image: ghcr.io/ahm3t0t/bigfive-base-opensuse:latest
            setup: zypper --non-interactive install curl wget sudo gawk ca-certificates hostname tar gzip
          - distro: alpine
            pkg_manager: APK
            image: alpine:3.20
            ghcr_image: ghcr.io/ahm3t0t/bigfive-base-alpine:latest
            setup: apk add --no-cache curl wget sudo gawk ca-certificates bash

    container:
      image: ${{ matrix.image }}
      options: --user root

    steps:
      - name: Setup container
        run: ${{ matrix.setup }}

      - name: Checkout
        uses: actions/checkout@v6

      - name: Create directories
        run: |
          mkdir -p /var/log/bigfive-updater
          mkdir -p /usr/share/bigfive-updater/lang
          mkdir -p /usr/local/bin

      - name: Install guncel
        run: |
          cp guncel /usr/local/bin/guncel
          chmod +x /usr/local/bin/guncel
          cp lang/*.sh /usr/share/bigfive-updater/lang/
          ln -sf /usr/local/bin/guncel /usr/local/bin/updater
          ln -sf /usr/local/bin/guncel /usr/local/bin/bigfive

      - name: Test --help
        run: guncel --help

      - name: Test --doctor
        run: guncel --doctor

      - name: Test --history
        run: guncel --history

      - name: Test --dry-run
        run: guncel --dry-run

      - name: Test --json
        run: guncel --json --dry-run | head -20

      - name: Test uninstall
        run: |
          rm -f /usr/local/bin/guncel /usr/local/bin/updater /usr/local/bin/bigfive
          rm -rf /usr/share/bigfive-updater

      - name: Summary
        env:
          DISTRO: ${{ matrix.distro }}
          PKG_MGR: ${{ matrix.pkg_manager }}
        run: |
          echo "========================================"
          echo "  ${DISTRO} (${PKG_MGR}) - ALL TESTS PASSED"
          echo "========================================"

  # ==================== BATS Unit Tests with Coverage ====================
  bats:
    name: BATS Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install BATS
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Build kcov from source
        run: |
          # Install build dependencies
          sudo apt-get install -y cmake libcurl4-openssl-dev libdw-dev binutils-dev zlib1g-dev
          # Clone and build kcov
          git clone --depth 1 https://github.com/SimonKagstrom/kcov.git /tmp/kcov
          cd /tmp/kcov
          mkdir build && cd build
          cmake ..
          make -j$(nproc)
          sudo make install
          kcov --version

      - name: Run BATS tests
        run: bats tests/guncel.bats tests/install.bats

      - name: Generate coverage for guncel
        run: |
          # Run guncel with various flags through kcov
          kcov --include-path=$(pwd)/guncel ./coverage ./guncel --help || true
          kcov --include-path=$(pwd)/guncel ./coverage ./guncel --version || true
          kcov --include-path=$(pwd)/guncel ./coverage ./guncel --doctor || true
          kcov --include-path=$(pwd)/guncel ./coverage ./guncel --dry-run || true
          kcov --include-path=$(pwd)/guncel ./coverage ./guncel --history || true
          kcov --include-path=$(pwd)/guncel ./coverage ./guncel --json --dry-run || true

      - name: Debug coverage output
        run: |
          echo "=== Coverage files ==="
          find ./coverage -name "cobertura.xml" -exec ls -la {} \;
          echo "=== Coverage summary ==="
          grep -h "line-rate" ./coverage/*/cobertura.xml 2>/dev/null | head -5 || echo "No coverage data"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./coverage
          fail_ci_if_error: false
          verbose: true

  # ==================== Summary ====================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, multi-distro, bats]
    if: always()

    steps:
      - name: Check results
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          DISTRO_RESULT: ${{ needs.multi-distro.result }}
          BATS_RESULT: ${{ needs.bats.result }}
        run: |
          if [[ "${LINT_RESULT}" != "success" ]]; then
            echo "Lint failed"
            exit 1
          fi
          if [[ "${DISTRO_RESULT}" != "success" ]]; then
            echo "Multi-distro tests failed"
            exit 1
          fi
          if [[ "${BATS_RESULT}" != "success" ]]; then
            echo "BATS tests failed"
            exit 1
          fi
          echo "========================================"
          echo "  ALL CI CHECKS PASSED"
          echo "========================================"
          echo ""
          echo "  - Lint: ${LINT_RESULT}"
          echo "  - Multi-distro (5 distros): ${DISTRO_RESULT}"
          echo "  - BATS (173 tests): ${BATS_RESULT}"
          echo "========================================"
