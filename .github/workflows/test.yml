name: Tests

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
      - '.github/CODEOWNERS'
      - '.github/dependabot.yml'
      - 'SHA256SUMS*'
      - 'pubkey.asc'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
      - '.github/CODEOWNERS'
      - '.github/dependabot.yml'
      - 'SHA256SUMS*'
      - 'pubkey.asc'

# Note: ShellCheck is run in ci.yml (ShellCheck Lint job)
# This workflow focuses on syntax and install tests

jobs:
  syntax-check:
    name: Bash Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Check syntax
        run: bash -n guncel && bash -n install.sh && bash -n release.sh

  bats-tests:
    name: BATS Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install BATS
        run: |
          sudo apt-get update
          sudo apt-get install -y bats
      - name: Run BATS tests
        run: bats tests/*.bats

  # v5.1 BigFive: Multi-distro install test matrix
  multi-distro-test:
    name: Install Test (${{ matrix.distro }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu
            image: ubuntu:24.04
            pkg_manager: apt
            install_deps: apt-get update && apt-get install -y curl wget gnupg ca-certificates
          - distro: fedora
            image: fedora:40
            pkg_manager: dnf
            install_deps: dnf install -y curl wget gnupg2 ca-certificates
          - distro: arch
            image: archlinux:latest
            pkg_manager: pacman
            install_deps: pacman -Syu --noconfirm && pacman -S --noconfirm curl wget gnupg ca-certificates
          - distro: opensuse
            image: opensuse/tumbleweed:latest
            pkg_manager: zypper
            install_deps: zypper refresh && zypper install -y curl wget gpg2 ca-certificates gawk
          - distro: alpine
            image: alpine:3.20
            pkg_manager: apk
            install_deps: apk update && apk add --no-cache bash curl wget gnupg ca-certificates coreutils gawk

    container:
      image: ${{ matrix.image }}

    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        run: ${{ matrix.install_deps }}

      - name: Test install.sh (local file)
        run: |
          # Test local installation (not from GitHub)
          bash install.sh

      - name: Verify guncel installed
        run: |
          test -f /usr/local/bin/guncel
          guncel --help | head -5

      - name: Verify updater symlink
        run: |
          test -L /usr/local/bin/updater
          updater --help | head -5

      - name: Verify ${{ matrix.pkg_manager }} is recognized
        run: |
          guncel --help | grep -i "${{ matrix.pkg_manager }}"
