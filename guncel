#!/usr/bin/env bash
#
# ARCB Wider Updater v3.4.4 - Informative
# GitHub: https://github.com/ahm3t0t/arcb-wider-updater
#

# --- AYARLAR ---
VERSION="3.4.4"
CODENAME="Informative"
LOG_DIR="/var/log/arcb-updater"
LOG_FILE="$LOG_DIR/update_$(date +%Y%m%d_%H%M%S).log"
GITHUB_RAW_URL="https://raw.githubusercontent.com/ahm3t0t/arcb-wider-updater/main/guncel"

# STRICT MODE
set -Eeuo pipefail

# GÃœVENLÄ°K: Log ve temp dosyalar sadece root okusun
umask 0077

# Renkler
RED='\033'
GREEN='\033'
YELLOW='\033'
BLUE='\033'
BOLD='\033'
NC='\033'

# --- YENÄ°: MODLAR VE SAYAÃ‡LAR ---
VERBOSE_MODE=false
QUIET_MODE=false
AUTO_MODE=false

# GÃ¼ncelleme sayaÃ§larÄ±
APT_COUNT=0
DNF_COUNT=0
FLATPAK_COUNT=0
SNAP_COUNT=0
FWUPD_COUNT=0
SNAPSHOT_NAME=""

# --- TRAP & LOGGING ---
finish_logging() {
    local ec=$?
    if [ -f "$LOG_FILE" ]; then
        echo "[$(date '+%F %T')] INFO: Finished with exit_code=$ec" >> "$LOG_FILE"
    fi
}
trap finish_logging EXIT

print_header() {
    if [[ "$QUIET_MODE" == "true" ]]; then return; fi
    echo -e "\n${BLUE}${BOLD}>>> $1 ${NC}"
    echo -e "${BLUE}--------------------------------------------------${NC}"
    echo "[$(date '+%F %T')] >>> $1" >> "$LOG_FILE"
}

print_error() {
    echo -e "${RED}${BOLD}âŒ HATA: $1 ${NC}"
    echo "[$(date '+%F %T')] ERROR: $1" >> "$LOG_FILE"
}

print_warning() {
    if [[ "$QUIET_MODE" == "true" ]]; then
        echo "[$(date '+%F %T')] WARN: $1" >> "$LOG_FILE"
        return
    fi
    echo -e "${YELLOW}âš ï¸  UYARI: $1 ${NC}"
    echo "[$(date '+%F %T')] WARN: $1" >> "$LOG_FILE"
}

print_success() {
    if [[ "$QUIET_MODE" == "true" ]]; then
        echo "[$(date '+%F %T')] SUCCESS: $1" >> "$LOG_FILE"
        return
    fi
    echo -e "${GREEN}${BOLD}âœ… $1 ${NC}"
    echo "[$(date '+%F %T')] SUCCESS: $1" >> "$LOG_FILE"
}

print_info() {
    if [[ "$QUIET_MODE" == "true" ]]; then
        echo "[$(date '+%F %T')] INFO: $1" >> "$LOG_FILE"
        return
    fi
    if [[ "$VERBOSE_MODE" == "true" ]]; then
        echo -e "${BLUE}â„¹ï¸  $1${NC}"
    fi
    echo "[$(date '+%F %T')] INFO: $1" >> "$LOG_FILE"
}

# --- YENÄ°: SÄ°STEM BÄ°LGÄ°SÄ° BAÅžLIK KUTUSU ---
print_system_header() {
    local hostname_str
    hostname_str=$(hostname 2>/dev/null || echo "unknown")
    local user_str
    user_str=$(whoami 2>/dev/null || echo "unknown")
    local kernel_str
    kernel_str=$(uname -r 2>/dev/null || echo "unknown")
    local ram_str
    ram_str=$(free -h 2>/dev/null | awk '/^Mem:/{print $2}' || echo "N/A")
    local disk_str
    disk_str=$(df -h / 2>/dev/null | awk 'NR==2{print $5}' || echo "N/A")
    
    echo -e "${GREEN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    printf "â•‘  %-40s â•‘\n" "ARCB-WIDER-UPDATER v$VERSION"
    printf "â•‘  %-40s â•‘\n" "Host: $hostname_str | User: $user_str"
    printf "â•‘  %-40s â•‘\n" "Kernel: $kernel_str"
    printf "â•‘  %-40s â•‘\n" "RAM: $ram_str | Disk: $disk_str used"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    # Log'a da yaz
    {
        echo "=================================================="
        echo "PRE-UPDATE SYSTEM INFO"
        echo "Version    : $VERSION ($CODENAME)"
        echo "Hostname   : $hostname_str"
        echo "User       : $user_str"
        echo "Kernel     : $kernel_str"
        echo "RAM        : $ram_str"
        echo "Disk Usage : $disk_str"
        echo "=================================================="
    } >> "$LOG_FILE"
}

# --- YENÄ°: REBOOT GEREKLÄ° MÄ° KONTROLÃœ ---
check_reboot_required() {
    # Debian/Ubuntu: /var/run/reboot-required dosyasÄ±
    if [[ -f "/var/run/reboot-required" ]]; then
        echo "Gerekli"
        return
    fi
    
    # Fedora/RHEL: needs-restarting komutu
    if command -v needs-restarting &> /dev/null; then
        if ! needs-restarting -r &> /dev/null; then
            echo "Gerekli"
            return
        fi
    fi
    
    echo "Gerekli deÄŸil"
}

# --- YENÄ°: FÄ°NAL Ã–ZET KUTUSU ---
print_final_summary() {
    local reboot_status
    reboot_status=$(check_reboot_required)
    local total_updates=$((APT_COUNT + DNF_COUNT + FLATPAK_COUNT + SNAP_COUNT + FWUPD_COUNT))
    
    echo -e "\n${GREEN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  âœ“ GÃœNCELLEME TAMAMLANDI                 â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    
    # APT veya DNF
    if command -v apt-get &> /dev/null; then
        if [[ $APT_COUNT -gt 0 ]]; then
            printf "â•‘  APT: %-33s â•‘\n" "$APT_COUNT paket gÃ¼ncellendi"
        else
            printf "â•‘  APT: %-33s â•‘\n" "GÃ¼ncel"
        fi
    fi
    
    if command -v dnf &> /dev/null; then
        if [[ $DNF_COUNT -gt 0 ]]; then
            printf "â•‘  DNF: %-33s â•‘\n" "$DNF_COUNT paket gÃ¼ncellendi"
        else
            printf "â•‘  DNF: %-33s â•‘\n" "GÃ¼ncel"
        fi
    fi
    
    # Flatpak
    if command -v flatpak &> /dev/null; then
        if [[ $FLATPAK_COUNT -gt 0 ]]; then
            printf "â•‘  Flatpak: %-29s â•‘\n" "$FLATPAK_COUNT uygulama gÃ¼ncellendi"
        else
            printf "â•‘  Flatpak: %-29s â•‘\n" "GÃ¼ncel"
        fi
    fi
    
    # Snap
    if command -v snap &> /dev/null; then
        if [[ $SNAP_COUNT -gt 0 ]]; then
            printf "â•‘  Snap: %-32s â•‘\n" "$SNAP_COUNT paket gÃ¼ncellendi"
        else
            printf "â•‘  Snap: %-32s â•‘\n" "GÃ¼ncel"
        fi
    fi
    
    # Firmware
    if command -v fwupdmgr &> /dev/null; then
        if [[ $FWUPD_COUNT -gt 0 ]]; then
            printf "â•‘  Firmware: %-28s â•‘\n" "$FWUPD_COUNT gÃ¼ncelleme"
        else
            printf "â•‘  Firmware: %-28s â•‘\n" "GÃ¼ncel"
        fi
    fi
    
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    
    # Snapshot bilgisi
    if [[ -n "$SNAPSHOT_NAME" ]]; then
        printf "â•‘  Snapshot: %-28s â•‘\n" "$SNAPSHOT_NAME"
    else
        printf "â•‘  Snapshot: %-28s â•‘\n" "OluÅŸturulmadÄ±"
    fi
    
    # Reboot durumu
    if [[ "$reboot_status" == "Gerekli" ]]; then
        printf "â•‘  Reboot: %-30s â•‘\n" "âš ï¸  Gerekli"
    else
        printf "â•‘  Reboot: %-30s â•‘\n" "Gerekli deÄŸil"
    fi
    
    # Log yolu
    printf "â•‘  Log: %-33s â•‘\n" "$LOG_FILE"
    
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    # Log'a da yaz
    {
        echo "=================================================="
        echo "POST-UPDATE SUMMARY"
        echo "Total Updates: $total_updates"
        [[ $APT_COUNT -gt 0 ]] && echo "APT: $APT_COUNT packages"
        [[ $DNF_COUNT -gt 0 ]] && echo "DNF: $DNF_COUNT packages"
        [[ $FLATPAK_COUNT -gt 0 ]] && echo "Flatpak: $FLATPAK_COUNT apps"
        [[ $SNAP_COUNT -gt 0 ]] && echo "Snap: $SNAP_COUNT packages"
        [[ $FWUPD_COUNT -gt 0 ]] && echo "Firmware: $FWUPD_COUNT updates"
        echo "Snapshot: ${SNAPSHOT_NAME:-None}"
        echo "Reboot Required: $reboot_status"
        echo "=================================================="
    } >> "$LOG_FILE"
}

setup_logging() {
    if [ ! -d "$LOG_DIR" ]; then
        mkdir -p "$LOG_DIR"
    fi
    
    local deleted_count
    deleted_count=$(find "$LOG_DIR" -name "update_*.log" -type f -mtime +30 -print -delete | wc -l)
    
    touch "$LOG_FILE"
    chmod 600 "$LOG_FILE"
    
    {
        echo "=================================================="
        echo "ARCB Wider Updater v$VERSION ($CODENAME)"
        echo "Start Time : $(date '+%F %T')"
        echo "User       : $(whoami)"
        echo "Hostname   : $(hostname)"
        echo "Mode       : $([[ "${AUTO_MODE:-false}" == "true" ]] && echo "AUTO" || echo "INTERACTIVE")"
        echo "Verbose    : $VERBOSE_MODE"
        echo "Quiet      : $QUIET_MODE"
        echo "=================================================="
        if [[ "$deleted_count" -gt 0 ]]; then
            echo "INFO: $deleted_count adet eski log dosyasÄ± temizlendi."
        fi
    } >> "$LOG_FILE"
}

download_file() {
    local url="$1"
    local output="$2"
    
    if command -v curl &> /dev/null; then
        curl -fsSL "$url" -o "$output"
    elif command -v wget &> /dev/null; then
        wget -qO "$output" "$url"
    else
        print_error "Sistemde 'curl' veya 'wget' bulunamadÄ±!"
        exit 1
    fi
}

check_connectivity() {
    if [[ "$QUIET_MODE" != "true" ]]; then
        echo -ne "${YELLOW}ðŸŒ BaÄŸlantÄ± kontrol ediliyor... ${NC}"
    fi
    local UA="Mozilla/5.0 (compat; ARCBUpdater/$VERSION)"
    
    local raw_ok=false
    if command -v curl &> /dev/null; then
        if curl -s -I -f -L -A "$UA" "$GITHUB_RAW_URL" > /dev/null; then raw_ok=true; fi
    elif command -v wget &> /dev/null; then
        if wget -q --spider --user-agent="$UA" "$GITHUB_RAW_URL"; then raw_ok=true; fi
    fi
    
    if [[ "$raw_ok" == "true" ]]; then
        if [[ "$QUIET_MODE" != "true" ]]; then
            echo -e "${GREEN}BaÄŸlÄ±.${NC}"
        fi
        return 0
    else
        if [[ "$QUIET_MODE" != "true" ]]; then
            echo -e "${YELLOW}KÄ±smi (Repo eriÅŸimi yok).${NC}"
        fi
        print_warning "Repo dosyalarÄ±na eriÅŸilemiyor. Self-update devre dÄ±ÅŸÄ±."
        export SELF_UPDATE_DISABLED="true"
        return 0
    fi
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${YELLOW}ðŸ”’ Root yetkisi gerekiyor...${NC}"
        if command -v sudo &> /dev/null; then
            exec sudo -E "$0" "$@"
        else
            print_error "Sudo yok ve root deÄŸilsin."
            exit 1
        fi
    fi
}

check_self_update() {
    if [[ "${SELF_UPDATE_DISABLED:-false}" == "true" ]]; then return; fi

    local REMOTE_FILE; REMOTE_FILE="$(mktemp /tmp/guncel_remote_XXXXXX)"
    local REMOTE_HASH
    local LOCAL_HASH
    
    if ! download_file "$GITHUB_RAW_URL" "$REMOTE_FILE"; then return; fi

    if ! grep -q "ARCB Wider Updater" "$REMOTE_FILE"; then
        rm -f "$REMOTE_FILE"
        return
    fi

    REMOTE_HASH=$(sha256sum "$REMOTE_FILE" | awk '{print $1}')
    LOCAL_HASH=$(sha256sum "$0" | awk '{print $1}')

    if [[ "$REMOTE_HASH" != "$LOCAL_HASH" && -n "$REMOTE_HASH" ]]; then
        echo -e "\n${YELLOW}ðŸ’¡ Yeni sÃ¼rÃ¼m mevcut!${NC}"
        if [[ "${AUTO_MODE:-false}" == "true" ]]; then
             REPLY="e"
        else
             read -p "   GÃ¼ncellemek ister misin? (e/H): " -n 1 -r
             echo
        fi

        if [[ ${REPLY:-H} =~ ^[Ee]$ ]]; then
            print_header "Self-Update BaÅŸlatÄ±lÄ±yor..."
            if install -m 0755 "$REMOTE_FILE" "$0"; then
                print_success "Script gÃ¼ncellendi. Yeniden baÅŸlatÄ±lÄ±yor..."
                exec "$0" "$@"
            else
                print_error "GÃ¼ncelleme kopyalanamadÄ±!"
                exit 1
            fi
        fi
    fi
    rm -f "$REMOTE_FILE"
}

wait_for_lock() {
    local has_checker="false"
    if command -v fuser &> /dev/null; then has_checker="fuser";
    elif command -v lsof &> /dev/null; then has_checker="lsof"; fi

    if [[ "$has_checker" == "false" ]]; then return; fi

    local max_retries=15
    local count=0
    local lock_files=("/var/lib/dpkg/lock" "/var/lib/dpkg/lock-frontend" "/var/lib/apt/lists/lock" "/var/cache/apt/archives/lock")
    
    while true; do
        local locked=false
        for lock in "${lock_files[@]}"; do
            if [[ "$has_checker" == "fuser" ]]; then
                if fuser "$lock" >/dev/null 2>&1; then locked=true; break; fi
            elif [[ "$has_checker" == "lsof" ]]; then
                if lsof "$lock" >/dev/null 2>&1; then locked=true; break; fi
            fi
        done

        if [[ "$locked" == "false" ]]; then break; fi

        if [ $count -ge $max_retries ]; then
            print_error "APT kilitleri kaldÄ±rÄ±lamadÄ±. Manuel mÃ¼dahale gerek."
            exit 1
        fi
        
        echo -e "${YELLOW}â³ APT kilitli ($has_checker), bekleniyor... ($count/$max_retries)${NC}"
        sleep 5
        ((count++))
    done
}

create_snapshot() {
    if command -v timeshift &> /dev/null; then
        print_header "Sistem Yedekleniyor (Timeshift)"
        SNAPSHOT_NAME="ARCB-Update-$(date +%F)"
        if [[ "$VERBOSE_MODE" == "true" ]]; then
            timeshift --create --comments "$SNAPSHOT_NAME" --tags D 2>&1 | tee -a "$LOG_FILE"
        else
            timeshift --create --comments "$SNAPSHOT_NAME" --tags D >> "$LOG_FILE" 2>&1
            print_success "Timeshift snapshot oluÅŸturuldu."
        fi
        return
    fi

    if command -v snapper &> /dev/null; then
        print_header "Sistem Yedekleniyor (Snapper)"
        SNAPSHOT_NAME="ARCB-Update-$(date +%F)"
        if snapper create --description "$SNAPSHOT_NAME" --cleanup-algorithm number >> "$LOG_FILE" 2>&1; then
             print_success "Snapper snapshot oluÅŸturuldu."
        else
             print_warning "Snapper snapshot oluÅŸturulamadÄ±."
             SNAPSHOT_NAME=""
        fi
        return
    fi
    
    if [[ "${AUTO_MODE:-false}" != "true" ]]; then
         echo "[$(date '+%F %T')] INFO: Yedekleme aracÄ± (Timeshift/Snapper) yok." >> "$LOG_FILE"
    fi
}

perform_updates() {
    local apt_opts=()
    if [[ "${AUTO_MODE:-false}" == "true" ]]; then
        export DEBIAN_FRONTEND=noninteractive
        apt_opts=(-o "Dpkg::Options::=--force-confdef" -o "Dpkg::Options::=--force-confold")
    fi

    if command -v apt-get &> /dev/null; then
        wait_for_lock
        print_header "APT: GÃ¼ncelleme BaÅŸlÄ±yor"
        
        if [[ "$VERBOSE_MODE" == "true" ]]; then
            apt-get update 2>&1 | tee -a "$LOG_FILE"
        else
            apt-get update >> "$LOG_FILE" 2>&1
        fi
        
        print_header "APT: Dist-Upgrade"
        # GÃ¼ncelleme sayÄ±sÄ±nÄ± al
        local apt_upgradable
        apt_upgradable=$(apt-get -s dist-upgrade 2>/dev/null | grep -c "^Inst " || echo "0")
        APT_COUNT=$apt_upgradable
        
        if [[ "$VERBOSE_MODE" == "true" ]]; then
            apt-get dist-upgrade -y "${apt_opts[@]}" 2>&1 | tee -a "$LOG_FILE"
        else
            apt-get dist-upgrade -y "${apt_opts[@]}" >> "$LOG_FILE" 2>&1
        fi
        
        print_header "APT: Temizlik"
        if [[ "$VERBOSE_MODE" == "true" ]]; then
            apt-get autoremove -y "${apt_opts[@]}" 2>&1 | tee -a "$LOG_FILE"
            apt-get autoclean -y "${apt_opts[@]}" 2>&1 | tee -a "$LOG_FILE"
        else
            apt-get autoremove -y "${apt_opts[@]}" >> "$LOG_FILE" 2>&1
            apt-get autoclean -y "${apt_opts[@]}" >> "$LOG_FILE" 2>&1
        fi
        
        print_info "APT: $APT_COUNT paket gÃ¼ncellendi."

    elif command -v dnf &> /dev/null; then
        print_header "DNF: GÃ¼ncelleme"
        
        # GÃ¼ncelleme sayÄ±sÄ±nÄ± al
        local dnf_upgradable
        dnf_upgradable=$(dnf check-update --quiet 2>/dev/null | grep -c "^[a-zA-Z]" || echo "0")
        DNF_COUNT=$dnf_upgradable
        
        if [[ "$VERBOSE_MODE" == "true" ]]; then
            dnf upgrade --refresh -y 2>&1 | tee -a "$LOG_FILE"
        else
            dnf upgrade --refresh -y >> "$LOG_FILE" 2>&1
        fi
        
        print_info "DNF: $DNF_COUNT paket gÃ¼ncellendi."
    fi

    if command -v flatpak &> /dev/null; then
        print_header "Flatpak: GÃ¼ncelleme"
        
        # GÃ¼ncelleme sayÄ±sÄ±nÄ± al
        local flatpak_upgradable
        flatpak_upgradable=$(flatpak remote-ls --updates 2>/dev/null | wc -l || echo "0")
        FLATPAK_COUNT=$flatpak_upgradable
        
        if [[ "$VERBOSE_MODE" == "true" ]]; then
            flatpak update -y 2>&1 | tee -a "$LOG_FILE" || print_warning "Flatpak hata verdi."
            flatpak uninstall --unused -y 2>&1 | tee -a "$LOG_FILE" || true
        else
            flatpak update -y >> "$LOG_FILE" 2>&1 || print_warning "Flatpak hata verdi."
            flatpak uninstall --unused -y >> "$LOG_FILE" 2>&1 || true
        fi
        
        print_info "Flatpak: $FLATPAK_COUNT uygulama gÃ¼ncellendi."
    fi

    if command -v snap &> /dev/null; then
        print_header "Snap: GÃ¼ncelleme"
        
        # Snap gÃ¼ncelleme sayÄ±sÄ±nÄ± al (snap refresh --list)
        local snap_upgradable
        snap_upgradable=$(snap refresh --list 2>/dev/null | tail -n +2 | wc -l || echo "0")
        SNAP_COUNT=$snap_upgradable
        
        if [[ "$VERBOSE_MODE" == "true" ]]; then
            snap refresh 2>&1 | tee -a "$LOG_FILE" || print_warning "Snap hata verdi."
        else
            snap refresh >> "$LOG_FILE" 2>&1 || print_warning "Snap hata verdi."
        fi
        
        print_info "Snap: $SNAP_COUNT paket gÃ¼ncellendi."
    fi
    
    if command -v fwupdmgr &> /dev/null; then
        print_header "Firmware: Kontrol"
        
        # Firmware gÃ¼ncelleme sayÄ±sÄ±nÄ± al
        local fwupd_upgradable
        fwupd_upgradable=$(fwupdmgr get-updates 2>/dev/null | grep -c "New version" || echo "0")
        FWUPD_COUNT=$fwupd_upgradable
        
        if [[ "${AUTO_MODE:-false}" == "true" ]]; then
            { fwupdmgr refresh --force || true; fwupdmgr update -y || true; } >> "$LOG_FILE" 2>&1
            if [[ "$QUIET_MODE" != "true" ]]; then
                echo -e "${GREEN}TamamlandÄ± (Detaylar log dosyasÄ±nda).${NC}"
            fi
        else
            if [[ "$VERBOSE_MODE" == "true" ]]; then
                fwupdmgr refresh --force 2>&1 | tee -a "$LOG_FILE" || true
                fwupdmgr update -y 2>&1 | tee -a "$LOG_FILE" || true
            else
                fwupdmgr refresh --force >> "$LOG_FILE" 2>&1 || true
                fwupdmgr update -y >> "$LOG_FILE" 2>&1 || true
            fi
        fi
        
        print_info "Firmware: $FWUPD_COUNT gÃ¼ncelleme."
    fi
}

show_help() {
    echo -e "${BOLD}ARCB Wider Updater v$VERSION ($CODENAME)${NC}"
    echo "--------------------------------------------------"
    echo "KullanÄ±m: guncel [SEÃ‡ENEK]"
    echo ""
    echo "SeÃ§enekler:"
    echo "  --auto      Otomatik mod (Onay sormadan gÃ¼nceller)"
    echo "  --verbose   DetaylÄ± Ã§Ä±ktÄ± modu (TÃ¼m komut Ã§Ä±ktÄ±larÄ±nÄ± gÃ¶sterir)"
    echo "  --quiet     Sessiz mod (Sadece hata ve Ã¶zet gÃ¶sterir)"
    echo "  --help      Bu yardÄ±m mesajÄ±nÄ± gÃ¶sterir"
    echo ""
    echo "Ã–rnekler:"
    echo "  guncel            -> Ä°nteraktif (Ã–nerilen)"
    echo "  guncel --auto     -> Cron / ZamanlanmÄ±ÅŸ gÃ¶revler"
    echo "  guncel --verbose  -> DetaylÄ± Ã§Ä±ktÄ± ile gÃ¼ncelleme"
    echo "  guncel --quiet    -> Sessiz gÃ¼ncelleme (sadece Ã¶zet)"
    exit 0
}

# --- ARGUMENT PARSING ---
for arg in "$@"; do
    case $arg in
        --auto) AUTO_MODE="true" ;;
        --verbose) VERBOSE_MODE="true" ;;
        --quiet) QUIET_MODE="true" ;;
        --help) show_help ;;
    esac
done

# Verbose ve quiet aynÄ± anda kullanÄ±lamaz
if [[ "$VERBOSE_MODE" == "true" && "$QUIET_MODE" == "true" ]]; then
    echo -e "${RED}HATA: --verbose ve --quiet aynÄ± anda kullanÄ±lamaz.${NC}"
    exit 1
fi

check_root "$@"
setup_logging

if ! check_connectivity; then
    print_error "Ä°nternet baÄŸlantÄ±sÄ± kurulamadÄ±. Ä°ÅŸlem iptal."
    exit 1
fi

check_self_update "$@"

if [[ "$AUTO_MODE" != "true" && "$QUIET_MODE" != "true" ]]; then clear; fi

# BaÅŸlangÄ±Ã§ Ã¶zeti
print_system_header

if [[ "$QUIET_MODE" != "true" ]]; then
    echo -e "${BLUE}   Log: $LOG_FILE${NC}"
    echo -e "${BLUE}   Mod: $( [[ "$AUTO_MODE" == "true" ]] && echo "Otomatik ðŸ¤–" || echo "Ä°nteraktif ðŸ‘¤" )${NC}"
    [[ "$VERBOSE_MODE" == "true" ]] && echo -e "${BLUE}   Verbose: Aktif${NC}"
    echo ""
fi

create_snapshot
perform_updates

# BitiÅŸ Ã¶zeti
print_final_summary
